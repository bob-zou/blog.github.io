
<!DOCTYPE html>
<html lang="zh-CN,en,default" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>【项目介绍】企业级运维管理平台 - 书山有路勤为径，学海无涯苦作舟</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="BobZou,"> 
    <meta name="description" content="
一站式运维管理平台，整合基础设施管理、部署发布、变更审批与配置管理，支撑百人规模研发团队的日常运维需求。

目录
项目背景
面临的挑战
整体架构设计
核心功能模块
架构演进历程
关键设计理念
外部,"> 
    <meta name="author" content="Bob Zou"> 
    <link rel="alternative" href="atom.xml" title="书山有路勤为径，学海无涯苦作舟" type="application/atom+xml"> 
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/bob-zou/blog.github.io/img/favicon.png"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
<link rel="stylesheet" href="/css/bootstrap.css">

    
<link rel="stylesheet" href="/css/diaspora.css">

<meta name="generator" content="Hexo 5.4.2"></head>

<body class="loading">
    <span id="config-title" style="display:none">书山有路勤为径，学海无涯苦作舟</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="https://blog.zouyapeng.com"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">【项目介绍】企业级运维管理平台</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">【项目介绍】企业级运维管理平台</h1>
        <div class="stuff">
            <span>二月 03, 2026</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/CICD/" rel="tag">CICD</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/%E9%A1%B9%E7%9B%AE/" rel="tag">项目</a></li></ul>


        </div>
        <div class="content markdown">
            <blockquote>
<p>一站式运维管理平台，整合基础设施管理、部署发布、变更审批与配置管理，支撑百人规模研发团队的日常运维需求。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF">项目背景</a></li>
<li><a href="#%E9%9D%A2%E4%B8%B4%E7%9A%84%E6%8C%91%E6%88%98">面临的挑战</a></li>
<li><a href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">整体架构设计</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97">核心功能模块</a></li>
<li><a href="#%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B%E5%8E%86%E7%A8%8B">架构演进历程</a></li>
<li><a href="#%E5%85%B3%E9%94%AE%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5">关键设计理念</a></li>
<li><a href="#%E5%A4%96%E9%83%A8%E9%9B%86%E6%88%90%E7%94%9F%E6%80%81">外部集成生态</a></li>
<li><a href="#%E9%A1%B9%E7%9B%AE%E6%88%90%E6%9E%9C%E4%B8%8E%E6%95%B0%E6%8D%AE">项目成果与数据</a></li>
<li><a href="#%E5%B1%95%E6%9C%9B%E4%B8%8E%E6%8C%81%E7%BB%AD%E4%BC%98%E5%8C%96">展望与持续优化</a></li>
<li><a href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E5%8F%8D%E6%80%9D">总结与反思</a></li>
</ul>
<hr>
<h2 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h2><p>在一家快速发展的金融科技公司担任运维开发工程师，随着业务规模扩张，我们面临着日益复杂的基础设施管理挑战：<strong>多云环境</strong>（AWS 为主、GCP 为辅）、<strong>数十个微服务</strong>、<strong>多套环境</strong>（Dev/Fat/Prod）以及分布在不同时区的研发团队。</p>
<p>市面上的开源运维工具（如 CMDB、发布系统）虽然各有特色，但难以满足我们的定制化需求：</p>
<ul>
<li>现有 CMDB 工具与我们的多云架构集成困难</li>
<li>部署工具难以与内部 Jenkins Pipeline 深度整合</li>
<li>变更管理流程需要与工单系统联动</li>
</ul>
<p>基于以上考量，我主导开发了 <strong>OpSys</strong> —— 一个针对公司业务特点量身定制的企业级运维管理平台。平台采用 <strong>Django + DRF + Celery</strong> 的技术栈，经过三年的迭代，已成为支撑公司日常运维的核心系统。</p>
<p><strong>技术亮点预告</strong>：</p>
<ul>
<li>统一认证中心：Keycloak OIDC + LDAP 双后端支持</li>
<li>全流程自动化：工单驱动的 Jenkins 集成</li>
<li>多云资源管理：AWS/GCP 资源自动发现与同步</li>
<li>插件化部署系统：支持 EC2/EKS 多种部署模式</li>
</ul>
<hr>
<h2 id="面临的挑战"><a href="#面临的挑战" class="headerlink" title="面临的挑战"></a>面临的挑战</h2><p>在启动项目之前，我们做了深入的痛点分析。这些问题不是凭空想象的，而是来自真实的运维事故和效率瓶颈。</p>
<h3 id="基础设施管理分散"><a href="#基础设施管理分散" class="headerlink" title="基础设施管理分散"></a>基础设施管理分散</h3><p><strong>症状</strong>：运维工程师需要频繁切换 AWS Console、GCP Console、内部 Wiki 来查找资源信息。</p>
<p><strong>根因</strong>：缺乏统一的资源视图。EC2 实例信息散落在 AWS 控制台，服务与实例的映射关系只存在于工程师的脑海中。</p>
<p><strong>影响</strong>：</p>
<ul>
<li>故障排查时定位实例耗时过长</li>
<li>资源利用率无法有效评估</li>
<li>新人入职难以快速了解基础设施全貌</li>
</ul>
<h3 id="部署流程不规范"><a href="#部署流程不规范" class="headerlink" title="部署流程不规范"></a>部署流程不规范</h3><p><strong>症状</strong>：同一个服务，不同工程师的部署方式可能完全不同。</p>
<p><strong>根因</strong>：部署脚本散落在各处，缺乏标准化的发布流程。Jenkins Job 配置混乱，参数传递靠”口口相传”。</p>
<p><strong>影响</strong>：</p>
<ul>
<li>发布事故频发，回滚操作手忙脚乱</li>
<li>发布记录缺失，出问题时无法追溯</li>
<li>灰度发布、蓝绿部署难以实施</li>
</ul>
<h3 id="变更管理缺乏审计"><a href="#变更管理缺乏审计" class="headerlink" title="变更管理缺乏审计"></a>变更管理缺乏审计</h3><p><strong>症状</strong>：”这个配置是谁改的？””昨天的变更记录在哪里？”</p>
<p><strong>根因</strong>：变更操作通过 SSH 直连服务器执行，没有统一的变更入口和审批流程。</p>
<p><strong>影响</strong>：</p>
<ul>
<li>生产事故难以追溯根因</li>
<li>合规审计无法满足</li>
<li>变更风险无法评估</li>
</ul>
<h3 id="多系统认证割裂"><a href="#多系统认证割裂" class="headerlink" title="多系统认证割裂"></a>多系统认证割裂</h3><p><strong>症状</strong>：Jenkins、GitLab、运维工具各有一套账号体系。</p>
<p><strong>根因</strong>：早期各系统独立建设，缺乏统一身份管理规划。</p>
<p><strong>影响</strong>：</p>
<ul>
<li>账号管理成本高</li>
<li>离职员工权限回收不及时</li>
<li>安全审计困难</li>
</ul>
<h3 id="配置管理混乱"><a href="#配置管理混乱" class="headerlink" title="配置管理混乱"></a>配置管理混乱</h3><p><strong>症状</strong>：”这个服务的配置文件在哪个仓库？用的是哪个版本？”</p>
<p><strong>根因</strong>：配置文件散落在 Git 仓库、服务器本地、Nacos 等多处，版本关系不清晰。</p>
<p><strong>影响</strong>：</p>
<ul>
<li>配置漂移导致环境不一致</li>
<li>配置变更难以灰度发布</li>
<li>配置回滚困难</li>
</ul>
<hr>
<h2 id="整体架构设计"><a href="#整体架构设计" class="headerlink" title="整体架构设计"></a>整体架构设计</h2><h3 id="架构概览"><a href="#架构概览" class="headerlink" title="架构概览"></a>架构概览</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                       前端 (Vue 3)                          │</span><br><span class="line">└─────────────────────────────┬───────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">┌─────────────────────────────▼───────────────────────────────┐</span><br><span class="line">│                    AWS ELB / 反向代理                        │</span><br><span class="line">└─────────────────────────────┬───────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">          ┌───────────────────┼───────────────────┐</span><br><span class="line">          │                   │                   │</span><br><span class="line">    ┌─────▼─────┐       ┌─────▼─────┐      ┌─────▼─────┐</span><br><span class="line">    │  uWSGI    │       │  Celery   │      │  Celery   │</span><br><span class="line">    │  Worker   │       │  Worker   │      │  Beat     │</span><br><span class="line">    │ (Django)  │       │ (异步任务) │      │ (定时调度) │</span><br><span class="line">    └─────┬─────┘       └─────┬─────┘      └─────┬─────┘</span><br><span class="line">          │                   │                   │</span><br><span class="line">          └───────────────────┼───────────────────┘</span><br><span class="line">                              │</span><br><span class="line">          ┌───────────────────┼───────────────────┐</span><br><span class="line">          │                   │                   │</span><br><span class="line">    ┌─────▼─────┐       ┌─────▼─────┐      ┌─────▼─────┐</span><br><span class="line">    │  MySQL    │       │  Redis    │      │  Flower   │</span><br><span class="line">    │  (主库)   │       │ (缓存/队列)│      │ (任务监控) │</span><br><span class="line">    └───────────┘       └───────────┘      └───────────┘</span><br><span class="line">                              │</span><br><span class="line">                        外部服务集成</span><br><span class="line">          ┌───────────────────┼───────────────────┐</span><br><span class="line">          │         │         │         │         │</span><br><span class="line">       AWS EC2   Jenkins   Nacos    Consul    Slack</span><br><span class="line">       GCP VM    Pipeline  Config   Discovery  通知</span><br></pre></td></tr></table></figure>

<h3 id="分层设计"><a href="#分层设计" class="headerlink" title="分层设计"></a>分层设计</h3><table>
<thead>
<tr>
<th>层级</th>
<th>组件</th>
<th>职责</th>
</tr>
</thead>
<tbody><tr>
<td><strong>接入层</strong></td>
<td>ELB + uWSGI</td>
<td>负载均衡、SSL 终止、请求路由</td>
</tr>
<tr>
<td><strong>应用层</strong></td>
<td>Django + DRF</td>
<td>业务逻辑、API 接口、权限控制</td>
</tr>
<tr>
<td><strong>任务层</strong></td>
<td>Celery Worker</td>
<td>异步任务执行、Jenkins 集成</td>
</tr>
<tr>
<td><strong>调度层</strong></td>
<td>Celery Beat</td>
<td>定时任务、资源同步、健康检查</td>
</tr>
<tr>
<td><strong>数据层</strong></td>
<td>MySQL + Redis</td>
<td>持久化存储、缓存、消息队列</td>
</tr>
</tbody></table>
<h3 id="技术选型与考量"><a href="#技术选型与考量" class="headerlink" title="技术选型与考量"></a>技术选型与考量</h3><p><strong>为什么选择 Django + DRF？</strong></p>
<p>作为运维开发团队，我们需要快速迭代、稳定可靠的技术栈。Django 的”开箱即用”特性大大加速了开发进度：</p>
<ul>
<li>成熟的 ORM，减少数据库操作代码</li>
<li>内置的 Admin 后台，便于数据维护</li>
<li>DRF 提供标准化的 RESTful API 开发体验</li>
<li>丰富的第三方库生态（django-auth-ldap、mozilla-django-oidc 等）</li>
</ul>
<p><strong>为什么选择 Celery 而非其他队列？</strong></p>
<p>部署任务通常耗时较长（几分钟到几十分钟），同步执行会阻塞 HTTP 请求。我们需要异步任务框架来处理：</p>
<ul>
<li>Celery 与 Django 集成成熟，社区活跃</li>
<li>支持任务重试、失败回调等高级特性</li>
<li>Flower 提供开箱即用的任务监控</li>
<li>Redis 作为 Broker 性能优异且维护简单</li>
</ul>
<p><strong>Redis 的多用途设计</strong></p>
<p>为了避免不同用途之间的相互影响，我们将 Redis 按功能分配到不同的 DB：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DB 0: 通用缓存（用户登录阻止、速率限制等）</span></span><br><span class="line">REDIS_DB_CACHE = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DB 1: Django 缓存（ORM 查询缓存、DRF 响应缓存）</span></span><br><span class="line">REDIS_DB_DJANGO = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DB 2: Celery Broker &amp; Results</span></span><br><span class="line">REDIS_DB_CELERY = <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h3 id="Docker-容器化部署"><a href="#Docker-容器化部署" class="headerlink" title="Docker 容器化部署"></a>Docker 容器化部署</h3><p>生产环境采用 Docker Compose 编排，包含以下服务：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span>         <span class="comment"># uWSGI 服务器，处理 HTTP 请求</span></span><br><span class="line">  <span class="attr">worker:</span>      <span class="comment"># Celery Worker，执行异步任务</span></span><br><span class="line">  <span class="attr">beat:</span>        <span class="comment"># Celery Beat，定时任务调度</span></span><br><span class="line">  <span class="attr">flower:</span>      <span class="comment"># Celery Flower，任务监控界面</span></span><br></pre></td></tr></table></figure>

<p>这种设计便于水平扩展：流量高峰时可以增加 <code>web</code> 实例，部署密集期可以增加 <code>worker</code> 实例。</p>
<hr>
<h2 id="核心功能模块"><a href="#核心功能模块" class="headerlink" title="核心功能模块"></a>核心功能模块</h2><h3 id="CMDB：基础设施统一管理"><a href="#CMDB：基础设施统一管理" class="headerlink" title="CMDB：基础设施统一管理"></a>CMDB：基础设施统一管理</h3><p><strong>解决的问题</strong>：资源信息分散，缺乏统一视图</p>
<p><strong>核心功能</strong>：</p>
<ul>
<li><strong>多云资源自动同步</strong>：定时任务从 AWS/GCP API 拉取资源信息，自动更新 CMDB</li>
<li><strong>环境与服务建模</strong>：Environment → Service → Process → EC2 四层关系建模</li>
<li><strong>资源关系可视化</strong>：服务与实例、负载均衡器的关联一目了然</li>
</ul>
<p><strong>技术实现亮点</strong>：</p>
<p>多云资源同步采用 Celery 定时任务实现，支持增量更新：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@shared_task</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmdb_ec2_todb</span>(<span class="params">aws_id=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;同步 AWS EC2 实例到数据库</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    流程：</span></span><br><span class="line"><span class="string">    1. 调用 boto3 describe_instances 获取实例列表</span></span><br><span class="line"><span class="string">    2. 对比 CMDB 现有数据，识别新增/变更/删除</span></span><br><span class="line"><span class="string">    3. 批量更新数据库</span></span><br><span class="line"><span class="string">    4. 同步实例标签到 CMDB 字段</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> aws_config <span class="keyword">in</span> AWS_ACCOUNTS:</span><br><span class="line">        instances = get_ec2_instances(aws_config)</span><br><span class="line">        <span class="keyword">for</span> instance <span class="keyword">in</span> instances:</span><br><span class="line">            CmdbEc2.objects.update_or_create(</span><br><span class="line">                instance_id=instance[<span class="string">&#x27;InstanceId&#x27;</span>],</span><br><span class="line">                defaults=&#123;</span><br><span class="line">                    <span class="string">&#x27;name&#x27;</span>: get_tag(instance, <span class="string">&#x27;Name&#x27;</span>),</span><br><span class="line">                    <span class="string">&#x27;private_ip_address&#x27;</span>: instance[<span class="string">&#x27;PrivateIpAddress&#x27;</span>],</span><br><span class="line">                    <span class="string">&#x27;instance_type&#x27;</span>: instance[<span class="string">&#x27;InstanceType&#x27;</span>],</span><br><span class="line">                    <span class="comment"># ... 更多字段</span></span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<p><strong>数据模型设计</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CmdbEnvironments (环境)</span><br><span class="line">    └── CmdbEnvironmentService (环境-服务关联)</span><br><span class="line">            └── CmdbEnvironmentServiceEc2 (实例组)</span><br><span class="line">                    └── CmdbEc2 (EC2 实例)</span><br></pre></td></tr></table></figure>

<h3 id="Ticket：变更与审批流程"><a href="#Ticket：变更与审批流程" class="headerlink" title="Ticket：变更与审批流程"></a>Ticket：变更与审批流程</h3><p><strong>解决的问题</strong>：变更操作缺乏审批和审计</p>
<p><strong>核心功能</strong>：</p>
<ul>
<li><strong>工单状态机</strong>：Draft → Pending → Approved → Running → Completed</li>
<li><strong>流程模板化</strong>：预定义部署、回滚、配置变更等流程模板</li>
<li><strong>Jenkins 集成</strong>：工单审批通过后自动触发 Jenkins Pipeline</li>
</ul>
<p><strong>技术实现亮点</strong>：<br>工单系统采用”工单 + 流程 + 任务”三层设计：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Tickets (工单)</span><br><span class="line">    ├── TicketDetail (工单详情，包含 JSON 格式的参数)</span><br><span class="line">    └── TicketRecord (执行记录，关联流程步骤)</span><br><span class="line"></span><br><span class="line">TicketFlow (流程模板)</span><br><span class="line">    └── TicketFlowTask (流程步骤)</span><br><span class="line">            └── TicketFlowTaskParam (步骤参数定义)</span><br></pre></td></tr></table></figure>

<p>这种设计的好处是<strong>流程复用</strong>：同一个”服务部署”流程可以被多个工单引用，流程变更只需修改一处。</p>
<p><strong>Jenkins 回调机制</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Jenkins Pipeline 完成后回调 OpSys</span></span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">jenkins_callback</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Jenkins 构建完成回调</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    1. 根据 build_number 找到对应的 TicketRecord</span></span><br><span class="line"><span class="string">    2. 更新步骤状态（Finished/Failed）</span></span><br><span class="line"><span class="string">    3. 如果配置了自动继续，触发下一步骤</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    build_number = request.data.get(<span class="string">&#x27;build_number&#x27;</span>)</span><br><span class="line">    status = request.data.get(<span class="string">&#x27;status&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    record = TicketRecord.objects.get(jenkins_number=build_number)</span><br><span class="line">    record.status = <span class="string">&#x27;Finished&#x27;</span> <span class="keyword">if</span> status == <span class="string">&#x27;SUCCESS&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;Failed&#x27;</span></span><br><span class="line">    record.save()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> record.ticket_flow_task.is_next:</span><br><span class="line">        trigger_next_step(record)</span><br></pre></td></tr></table></figure>

<h3 id="CD2：现代化部署系统"><a href="#CD2：现代化部署系统" class="headerlink" title="CD2：现代化部署系统"></a>CD2：现代化部署系统</h3><p><strong>解决的问题</strong>：部署流程不规范，缺乏统一的发布管理</p>
<p><strong>核心功能</strong>：</p>
<ul>
<li><strong>插件化任务架构</strong>：部署、配置发布、进程管理等操作均为可插拔模块</li>
<li><strong>多部署类型支持</strong>：EC2 滚动部署、EKS 滚动更新、配置热加载</li>
<li><strong>LB 流量管理</strong>：部署前自动从负载均衡器卸载，部署后自动注册</li>
</ul>
<p><strong>技术实现亮点</strong>：</p>
<p>CD2 的核心是<strong>模块注册表</strong>设计，每种部署类型注册为独立模块：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd2/logic.py</span></span><br><span class="line">module = &#123;</span><br><span class="line">    <span class="string">&quot;deploy&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;record_runtime&quot;</span>: task_deploy.get_runtime_info,</span><br><span class="line">        <span class="string">&quot;record_pre_runtime&quot;</span>: task_deploy.get_pre_runtime_info,</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: task_deploy.flow_action,</span><br><span class="line">        <span class="string">&quot;jenkins_callback&quot;</span>: task_deploy.jenkins_callback,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;pm_deploy_all&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: task_service_configfile.flow_action_deploy,</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;batch_deploy&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: task_batch_deploy.flow_action,</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># ... 更多模块</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>支持的部署类型</strong>：</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>说明</th>
<th>场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>deploy</code></td>
<td>代码部署</td>
<td>服务版本更新</td>
</tr>
<tr>
<td><code>pm_deploy_all</code></td>
<td>配置全量部署</td>
<td>配置文件变更</td>
</tr>
<tr>
<td><code>pm_reload_all</code></td>
<td>配置热加载</td>
<td>不重启服务的配置更新</td>
</tr>
<tr>
<td><code>batch_deploy</code></td>
<td>批量部署</td>
<td>多实例并行部署</td>
</tr>
<tr>
<td><code>ncm_deploy</code></td>
<td>网络配置部署</td>
<td>网络设备配置变更</td>
</tr>
<tr>
<td><code>process_manage</code></td>
<td>进程管理</td>
<td>服务启停、重启</td>
</tr>
</tbody></table>
<h3 id="User：统一认证中心"><a href="#User：统一认证中心" class="headerlink" title="User：统一认证中心"></a>User：统一认证中心</h3><p><strong>解决的问题</strong>：多系统账号割裂，权限管理混乱</p>
<p><strong>核心功能</strong>：</p>
<ul>
<li><strong>Keycloak OIDC 集成</strong>：与公司统一身份平台对接</li>
<li><strong>LDAP 自动同步</strong>：用户信息从 LDAP 自动同步</li>
<li><strong>Token 即时阻止</strong>：登出后 Token 立即失效</li>
</ul>
<p><strong>技术实现亮点</strong>：<br>多认证后端的优雅降级设计：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AUTHENTICATION_BACKENDS = (</span><br><span class="line">    <span class="string">&#x27;utils.keycloak.MyOIDCBackend&#x27;</span>,           <span class="comment"># 主认证：Keycloak OIDC</span></span><br><span class="line">    <span class="string">&#x27;django.contrib.auth.backends.ModelBackend&#x27;</span>,  <span class="comment"># 降级：本地数据库</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>Token 阻止机制</strong>（解决 JWT 无法即时撤销的问题）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">set_block</span>(<span class="params">username</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;阻止用户登录（8小时有效）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    场景：用户登出、账号禁用、安全事件</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    redis_client.<span class="built_in">set</span>(<span class="string">f&quot;block:<span class="subst">&#123;username&#125;</span>&quot;</span>, <span class="number">1</span>, ex=<span class="number">8</span>*<span class="number">3600</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_is_block</span>(<span class="params">username</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检查用户是否被阻止&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> redis_client.exists(<span class="string">f&quot;block:<span class="subst">&#123;username&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在认证中间件中检查</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TokenAuthenticationMiddleware</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">self, request</span>):</span><br><span class="line">        token = get_token_from_header(request)</span><br><span class="line">        payload = decode_token(token)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> check_is_block(payload[<span class="string">&#x27;username&#x27;</span>]):</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;Token has been revoked&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>

<h3 id="Config：配置管理"><a href="#Config：配置管理" class="headerlink" title="Config：配置管理"></a>Config：配置管理</h3><p><strong>解决的问题</strong>：配置散落各处，版本难以追踪</p>
<p><strong>核心功能</strong>：</p>
<ul>
<li><strong>Nacos 集成</strong>：配置集中存储，支持动态推送</li>
<li><strong>配置版本管理</strong>：每次变更记录版本，支持回滚</li>
<li><strong>配置审计</strong>：记录配置变更的操作人、时间、变更内容</li>
</ul>
<p><strong>数据模型</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ConfigContext</span>(<span class="title class_ inherited__">ModelCreate</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;配置上下文（配置项的分组）&quot;&quot;&quot;</span></span><br><span class="line">    name = CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    key = CharField(max_length=<span class="number">255</span>, unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConfigInfo</span>(<span class="title class_ inherited__">ModelCreate</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;配置项&quot;&quot;&quot;</span></span><br><span class="line">    context = ForeignKey(ConfigContext)</span><br><span class="line">    key = CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    value = TextField()</span><br><span class="line">    version = IntegerField(default=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Changes</span>(<span class="title class_ inherited__">ModelCreate</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;变更审计日志&quot;&quot;&quot;</span></span><br><span class="line">    model_name = CharField(max_length=<span class="number">64</span>)</span><br><span class="line">    change_type = CharField(choices=[<span class="string">&#x27;create&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>])</span><br><span class="line">    before_value = TextField()</span><br><span class="line">    after_value = TextField()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="架构演进历程"><a href="#架构演进历程" class="headerlink" title="架构演进历程"></a>架构演进历程</h2><p>三年的迭代过程中，OpSys 经历了多次重要的架构升级。这些经历既是踩坑的教训，也是技术成长的见证。</p>
<h3 id="部署系统重构：cd-→-cd2"><a href="#部署系统重构：cd-→-cd2" class="headerlink" title="部署系统重构：cd/ → cd2/"></a>部署系统重构：cd/ → cd2/</h3><p><strong>旧系统（cd/）的问题</strong>：</p>
<p>早期的部署系统设计得比较”简单粗暴”：</p>
<ul>
<li>代码部署、配置部署、进程管理耦合在一起</li>
<li>每种新的部署类型都需要修改核心代码</li>
<li>流程控制逻辑散落各处，难以维护</li>
<li>与 Jenkins 的集成是”硬编码”的</li>
</ul>
<p><strong>重构思路</strong>：</p>
<ol>
<li><strong>解耦</strong>：将不同类型的部署操作拆分为独立模块</li>
<li><strong>通用化</strong>：抽象出 Flow → Step → Record 的通用模型</li>
<li><strong>插件化</strong>：新部署类型只需注册模块，无需修改框架代码</li>
</ol>
<p><strong>新旧对比</strong>：</p>
<table>
<thead>
<tr>
<th>方面</th>
<th>cd/（旧）</th>
<th>cd2/（新）</th>
</tr>
</thead>
<tbody><tr>
<td>架构</td>
<td>单体，紧耦合</td>
<td>模块化，松耦合</td>
</tr>
<tr>
<td>扩展性</td>
<td>低，需改核心代码</td>
<td>高，注册新模块即可</td>
</tr>
<tr>
<td>参数管理</td>
<td>固定 schema</td>
<td>灵活的 JSON schema</td>
</tr>
<tr>
<td>流程控制</td>
<td>线性</td>
<td>支持条件分支、并行</td>
</tr>
<tr>
<td>错误恢复</td>
<td>有限</td>
<td>支持重试、回滚</td>
</tr>
</tbody></table>
<p><strong>迁移策略</strong>：</p>
<p>我们采用了<strong>渐进式替换</strong>的方式：</p>
<ol>
<li>新功能全部在 cd2/ 中开发</li>
<li>旧系统（cd/）保持运行，确保现有流程不中断</li>
<li>逐步将存量工单迁移到 cd2/</li>
<li>最终标记 cd/ 为 deprecated</li>
</ol>
<blockquote>
<p>教训：技术债务越早还越好。cd/ 在早期满足了业务需求，但随着复杂度增加，维护成本急剧上升。如果一开始就采用模块化设计，后期可以节省大量重构成本。</p>
</blockquote>
<h3 id="认证体系升级"><a href="#认证体系升级" class="headerlink" title="认证体系升级"></a>认证体系升级</h3><p><strong>演进路径</strong>：本地账号 → LDAP → Keycloak OIDC</p>
<p><strong>第一阶段：本地账号</strong></p>
<p>最初使用 Django 内置的用户系统，账号密码存储在本地数据库。问题很快暴露：</p>
<ul>
<li>用户需要记住多套密码</li>
<li>离职员工权限回收不及时</li>
<li>无法与其他系统实现单点登录</li>
</ul>
<p><strong>第二阶段：LDAP 集成</strong></p>
<p>引入 <code>django-auth-ldap</code>，与公司 LDAP 对接：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AUTH_LDAP_SERVER_URI = <span class="string">&quot;ldap://ldap.company.com&quot;</span></span><br><span class="line">AUTH_LDAP_USER_DN_TEMPLATE = <span class="string">&quot;uid=%(user)s,ou=users,dc=company,dc=com&quot;</span></span><br></pre></td></tr></table></figure>

<p>这解决了账号统一的问题，但 LDAP 是”认证”而非”授权”，权限管理仍然需要在 OpSys 内部维护。</p>
<p><strong>第三阶段：Keycloak OIDC</strong></p>
<p>公司推行统一身份平台（Keycloak），我们改造 OpSys 对接 OIDC：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyOIDCBackend</span>(<span class="title class_ inherited__">OIDCAuthenticationBackend</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">self, claims</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据 OIDC claims 创建用户&quot;&quot;&quot;</span></span><br><span class="line">        user = AuthUserLDAP.objects.create_user(</span><br><span class="line">            username=claims[<span class="string">&#x27;preferred_username&#x27;</span>],</span><br><span class="line">            email=claims.get(<span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            displayname=claims.get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_user</span>(<span class="params">self, user, claims</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据 OIDC claims 更新用户信息&quot;&quot;&quot;</span></span><br><span class="line">        user.email = claims.get(<span class="string">&#x27;email&#x27;</span>, user.email)</span><br><span class="line">        user.displayname = claims.get(<span class="string">&#x27;name&#x27;</span>, user.displayname)</span><br><span class="line">        user.save()</span><br><span class="line">        <span class="keyword">return</span> user</span><br></pre></td></tr></table></figure>

<p><strong>挑战与解决方案</strong>：</p>
<ul>
<li><strong>Token 即时撤销</strong>：JWT 是无状态的，无法即时撤销。我们引入 Redis 存储”阻止名单”，每次请求都检查用户是否在名单中。</li>
<li><strong>多后端兼容</strong>：保留 ModelBackend 作为降级方案，Keycloak 不可用时可以使用本地账号登录。</li>
</ul>
<h3 id="从单体到模块化"><a href="#从单体到模块化" class="headerlink" title="从单体到模块化"></a>从单体到模块化</h3><p><strong>早期结构</strong>：</p>
<p>项目初期只有 cmdb/、ticket/、user/ 三个应用，所有功能都往这三个应用里塞。随着功能增加，代码变得臃肿难维护。</p>
<p><strong>模块化拆分</strong>：</p>
<p>我们按照”单一职责”原则，将功能拆分为 11 个独立应用：</p>
<table>
<thead>
<tr>
<th>应用</th>
<th>职责</th>
<th>独立原因</th>
</tr>
</thead>
<tbody><tr>
<td>cmdb/</td>
<td>基础设施管理</td>
<td>核心数据模型</td>
</tr>
<tr>
<td>ticket/</td>
<td>工单流程</td>
<td>独立的业务流程</td>
</tr>
<tr>
<td>cd2/</td>
<td>部署系统</td>
<td>复杂度高，独立维护</td>
</tr>
<tr>
<td>user/</td>
<td>用户认证</td>
<td>与其他应用解耦</td>
</tr>
<tr>
<td>config/</td>
<td>配置管理</td>
<td>独立的数据源（Nacos）</td>
</tr>
<tr>
<td>task/</td>
<td>后台任务</td>
<td>与部署系统深度耦合</td>
</tr>
<tr>
<td>tools/</td>
<td>工具集合</td>
<td>独立的运维工具</td>
</tr>
<tr>
<td>report/</td>
<td>报表导出</td>
<td>独立的异步任务</td>
</tr>
<tr>
<td>api/</td>
<td>外部接口</td>
<td>Webhook、第三方集成</td>
</tr>
<tr>
<td>opsjob/</td>
<td>运维任务</td>
<td>命令行执行</td>
</tr>
<tr>
<td>drp/</td>
<td>灾难恢复</td>
<td>独立的业务域</td>
</tr>
</tbody></table>
<p><strong>应用间通信</strong>：</p>
<p>应用之间通过 Django ORM 的外键关联，避免直接导入其他应用的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cmdb/models.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CmdbEnvironmentService</span>(<span class="title class_ inherited__">ModelCreate</span>):</span><br><span class="line">    cmdb_environments = ForeignKey(<span class="string">&#x27;cmdb.CmdbEnvironments&#x27;</span>)</span><br><span class="line">    cmdb_service = ForeignKey(<span class="string">&#x27;cmdb.CmdbService&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># cd2/models.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CdFlowRecord</span>(<span class="title class_ inherited__">ModelCreate</span>):</span><br><span class="line">    <span class="comment"># 通过 ContentType 实现与 Task 应用的松耦合</span></span><br><span class="line">    content_type = ForeignKey(ContentType)</span><br><span class="line">    object_id = PositiveIntegerField()</span><br><span class="line">    content_object = GenericForeignKey()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="关键设计理念"><a href="#关键设计理念" class="headerlink" title="关键设计理念"></a>关键设计理念</h2><h3 id="关注点分离"><a href="#关注点分离" class="headerlink" title="关注点分离"></a>关注点分离</h3><p>OpSys 的核心设计理念是<strong>关注点分离</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CMDB（是什么）→ Ticket（要做什么）→ Task（怎么做）→ 外部服务（执行）</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>CMDB</strong> 关注资源的<strong>状态</strong>：有哪些服务、部署在哪些实例、运行在什么环境</li>
<li><strong>Ticket</strong> 关注变更的<strong>流程</strong>：谁发起、谁审批、什么时候执行</li>
<li><strong>Task</strong> 关注执行的<strong>细节</strong>：调用哪个 Jenkins Job、传递什么参数</li>
</ul>
<p>这种设计的好处是<strong>变更影响最小化</strong>：</p>
<ul>
<li>新增资源类型？只需修改 CMDB</li>
<li>新增审批流程？只需修改 Ticket</li>
<li>新增部署方式？只需修改 Task</li>
</ul>
<h3 id="异步优先"><a href="#异步优先" class="headerlink" title="异步优先"></a>异步优先</h3><p>耗时操作一律走 Celery 异步任务：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 同步：用户体验差</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy_sync</span>(<span class="params">request</span>):</span><br><span class="line">    result = jenkins_build(job_name, params)  <span class="comment"># 可能等待5分钟</span></span><br><span class="line">    <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;result&#x27;</span>: result&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 异步：立即返回</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy_async</span>(<span class="params">request</span>):</span><br><span class="line">    task = jenkins_build.delay(job_name, params)  <span class="comment"># 立即返回</span></span><br><span class="line">    <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;task_id&#x27;</span>: task.<span class="built_in">id</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>异步任务的好处：</p>
<ul>
<li>用户不需要等待耗时操作完成</li>
<li>任务失败可以自动重试</li>
<li>任务进度可以实时查询</li>
</ul>
<h3 id="多租户与环境隔离"><a href="#多租户与环境隔离" class="headerlink" title="多租户与环境隔离"></a>多租户与环境隔离</h3><p>OpSys 支持多环境（Dev/Fat/Prod）和多业务线的隔离：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CmdbEnvironmentService</span>(<span class="title class_ inherited__">ModelCreate</span>):</span><br><span class="line">    cmdb_environments = ForeignKey(CmdbEnvironments)  <span class="comment"># 环境隔离</span></span><br><span class="line">    cmdb_service = ForeignKey(CmdbService)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        unique_together = (<span class="string">&#x27;cmdb_environments&#x27;</span>, <span class="string">&#x27;cmdb_service&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>不同环境的服务配置、部署参数、访问权限都是独立的。</p>
<h3 id="可观测性"><a href="#可观测性" class="headerlink" title="可观测性"></a>可观测性</h3><p><strong>分层日志</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># opsys/settings.py</span></span><br><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;main&#x27;</span>: &#123;<span class="string">&#x27;filename&#x27;</span>: <span class="string">&#x27;/data/logs/opsys.log&#x27;</span>&#125;,</span><br><span class="line">        <span class="string">&#x27;cd_flow&#x27;</span>: &#123;<span class="string">&#x27;filename&#x27;</span>: <span class="string">&#x27;/data/logs/opsys.cd_flow.log&#x27;</span>&#125;,</span><br><span class="line">        <span class="string">&#x27;commands&#x27;</span>: &#123;<span class="string">&#x27;filename&#x27;</span>: <span class="string">&#x27;/data/logs/opsys.commands.log&#x27;</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>opsys.log</code>：主应用日志</li>
<li><code>opsys.cd_flow.log</code>：部署流程日志</li>
<li><code>opsys.commands.log</code>：命令执行日志</li>
</ul>
<p><strong>任务监控</strong>：Celery Flower 提供任务的实时监控界面。</p>
<p><strong>Prometheus 集成</strong>：关键指标（部署成功率、任务队列长度等）暴露给 Prometheus。</p>
<h3 id="扩展性设计"><a href="#扩展性设计" class="headerlink" title="扩展性设计"></a>扩展性设计</h3><p><strong>插件化任务系统</strong>：新增部署类型只需注册模块，无需修改框架代码。</p>
<p><strong>通用模型基类</strong>：所有模型继承自通用基类，自动包含创建时间、修改时间、创建人等字段。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ModelCreate</span>(models.Model):</span><br><span class="line">    create_time = DateTimeField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    create_user = CharField(max_length=<span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        abstract = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelModify</span>(<span class="title class_ inherited__">ModelCreate</span>):</span><br><span class="line">    modify_time = DateTimeField(auto_now=<span class="literal">True</span>)</span><br><span class="line">    modify_user = CharField(max_length=<span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        abstract = <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="外部集成生态"><a href="#外部集成生态" class="headerlink" title="外部集成生态"></a>外部集成生态</h2><p>OpSys 的价值很大程度上来自于与外部系统的深度集成。</p>
<h3 id="集成全景图"><a href="#集成全景图" class="headerlink" title="集成全景图"></a>集成全景图</h3><table>
<thead>
<tr>
<th>领域</th>
<th>服务</th>
<th>集成方式</th>
<th>能力</th>
</tr>
</thead>
<tbody><tr>
<td><strong>云平台</strong></td>
<td>AWS</td>
<td>boto3 SDK</td>
<td>EC2、ELB、CloudFront、WAF 管理</td>
</tr>
<tr>
<td></td>
<td>GCP</td>
<td>google-cloud SDK</td>
<td>Compute Engine 管理</td>
</tr>
<tr>
<td><strong>CI/CD</strong></td>
<td>Jenkins</td>
<td>REST API</td>
<td>触发构建、获取状态、回调通知</td>
</tr>
<tr>
<td><strong>监控</strong></td>
<td>Prometheus</td>
<td>HTTP SD</td>
<td>服务发现、指标采集</td>
</tr>
<tr>
<td></td>
<td>AlertManager</td>
<td>API</td>
<td>告警静默</td>
</tr>
<tr>
<td><strong>配置</strong></td>
<td>Nacos</td>
<td>HTTP API</td>
<td>配置读写、监听变更</td>
</tr>
<tr>
<td></td>
<td>Consul</td>
<td>HTTP API</td>
<td>服务注册、KV 存储</td>
</tr>
<tr>
<td><strong>通知</strong></td>
<td>Slack</td>
<td>Webhook</td>
<td>部署通知、告警推送</td>
</tr>
<tr>
<td></td>
<td>Lark</td>
<td>Webhook</td>
<td>工单通知</td>
</tr>
<tr>
<td><strong>消息</strong></td>
<td>Kafka</td>
<td>kafka-python</td>
<td>事件流</td>
</tr>
</tbody></table>
<h3 id="AWS-多账户支持"><a href="#AWS-多账户支持" class="headerlink" title="AWS 多账户支持"></a>AWS 多账户支持</h3><p>企业级场景通常有多个 AWS 账户（生产、开发、安全等），OpSys 支持跨账户资源管理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主账户直接访问</span></span><br><span class="line">client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>, aws_access_key_id=ACCESS_KEY)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从账户通过 STS AssumeRole</span></span><br><span class="line">sts_client = boto3.client(<span class="string">&#x27;sts&#x27;</span>)</span><br><span class="line">assumed_role = sts_client.assume_role(</span><br><span class="line">    RoleArn=<span class="string">f&#x27;arn:aws:iam::<span class="subst">&#123;account_id&#125;</span>:role/<span class="subst">&#123;role_name&#125;</span>&#x27;</span>,</span><br><span class="line">    RoleSessionName=<span class="string">&#x27;OpSysSession&#x27;</span></span><br><span class="line">)</span><br><span class="line">credentials = assumed_role[<span class="string">&#x27;Credentials&#x27;</span>]</span><br><span class="line"></span><br><span class="line">client = boto3.client(</span><br><span class="line">    <span class="string">&#x27;ec2&#x27;</span>,</span><br><span class="line">    aws_access_key_id=credentials[<span class="string">&#x27;AccessKeyId&#x27;</span>],</span><br><span class="line">    aws_secret_access_key=credentials[<span class="string">&#x27;SecretAccessKey&#x27;</span>],</span><br><span class="line">    aws_session_token=credentials[<span class="string">&#x27;SessionToken&#x27;</span>]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="Jenkins-深度集成"><a href="#Jenkins-深度集成" class="headerlink" title="Jenkins 深度集成"></a>Jenkins 深度集成</h3><p>OpSys 与 Jenkins 的集成不仅是”触发构建”，而是完整的双向通信：</p>
<ol>
<li><strong>触发构建</strong>：OpSys 调用 Jenkins API 触发 Pipeline</li>
<li><strong>参数传递</strong>：部署参数通过 API 传递给 Jenkins</li>
<li><strong>状态同步</strong>：Jenkins Pipeline 执行过程中的状态实时同步</li>
<li><strong>回调通知</strong>：Pipeline 完成后回调 OpSys，触发后续流程</li>
</ol>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Jenkinsfile 中的回调</span></span><br><span class="line">post &#123;</span><br><span class="line">    always &#123;</span><br><span class="line">        script &#123;</span><br><span class="line">            <span class="keyword">def</span> status = currentBuild.result ?: <span class="string">&#x27;SUCCESS&#x27;</span></span><br><span class="line">            httpRequest(</span><br><span class="line">                <span class="symbol">url:</span> <span class="string">&quot;$&#123;OPSYS_URL&#125;/api/jenkins/callback/&quot;</span>,</span><br><span class="line">                <span class="symbol">httpMode:</span> <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                <span class="symbol">contentType:</span> <span class="string">&#x27;APPLICATION_JSON&#x27;</span>,</span><br><span class="line">                <span class="symbol">requestBody:</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    &quot;build_number&quot;: &quot;$&#123;BUILD_NUMBER&#125;&quot;,</span></span><br><span class="line"><span class="string">                    &quot;job_name&quot;: &quot;$&#123;JOB_NAME&#125;&quot;,</span></span><br><span class="line"><span class="string">                    &quot;status&quot;: &quot;$&#123;status&#125;&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="项目成果与数据"><a href="#项目成果与数据" class="headerlink" title="项目成果与数据"></a>项目成果与数据</h2><p>用数据说话：</p>
<table>
<thead>
<tr>
<th>指标</th>
<th>数值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>代码规模</strong></td>
<td>4291+ commits</td>
<td>三年持续迭代</td>
</tr>
<tr>
<td><strong>应用数量</strong></td>
<td>11 个核心应用</td>
<td>模块化设计</td>
</tr>
<tr>
<td><strong>API 端点</strong></td>
<td>100+</td>
<td>RESTful API 覆盖全功能</td>
</tr>
<tr>
<td><strong>外部集成</strong></td>
<td>8+ 服务</td>
<td>AWS、Jenkins、Nacos 等</td>
</tr>
<tr>
<td><strong>数据模型</strong></td>
<td>50+ 模型</td>
<td>覆盖完整的运维场景</td>
</tr>
<tr>
<td><strong>Celery 任务</strong></td>
<td>40+ 任务类型</td>
<td>异步化运维操作</td>
</tr>
</tbody></table>
<p><strong>业务价值</strong>：</p>
<ul>
<li>部署操作从手工执行变为工单驱动，<strong>变更可追溯率 100%</strong></li>
<li>资源信息从分散查找变为统一查询，<strong>故障定位效率提升 50%</strong></li>
<li>账号体系从多套密码变为 SSO 单点登录，<strong>账号管理成本降低 80%</strong></li>
</ul>
<hr>
<h2 id="展望与持续优化"><a href="#展望与持续优化" class="headerlink" title="展望与持续优化"></a>展望与持续优化</h2><p>OpSys 仍在持续迭代中，以下是近期规划：</p>
<h3 id="权限体系精细化"><a href="#权限体系精细化" class="headerlink" title="权限体系精细化"></a>权限体系精细化</h3><p>当前权限控制粒度较粗（基于用户组），计划引入更细粒度的 RBAC 模型：</p>
<ul>
<li>资源级别的权限控制（某用户只能操作特定服务）</li>
<li>操作级别的权限控制（某用户只能查看、不能修改）</li>
</ul>
<h3 id="EKS-云原生深度支持"><a href="#EKS-云原生深度支持" class="headerlink" title="EKS/云原生深度支持"></a>EKS/云原生深度支持</h3><p>随着业务向 Kubernetes 迁移，OpSys 需要增强云原生支持：</p>
<ul>
<li>EKS 集群资源管理</li>
<li>Deployment/Pod 生命周期管理</li>
<li>Helm Chart 版本管理</li>
</ul>
<h3 id="Salt-配置管理集成"><a href="#Salt-配置管理集成" class="headerlink" title="Salt 配置管理集成"></a>Salt 配置管理集成</h3><p>计划集成 Salt 实现更强大的配置管理：</p>
<ul>
<li>配置文件模板化</li>
<li>配置推送与验证</li>
<li>配置漂移检测</li>
</ul>
<h3 id="自动化程度持续提升"><a href="#自动化程度持续提升" class="headerlink" title="自动化程度持续提升"></a>自动化程度持续提升</h3><ul>
<li>故障自愈：基于告警自动触发修复流程</li>
<li>容量规划：基于历史数据预测资源需求</li>
<li>成本优化：识别闲置资源，自动缩容建议</li>
</ul>
<hr>
<h2 id="总结与反思"><a href="#总结与反思" class="headerlink" title="总结与反思"></a>总结与反思</h2><h3 id="项目带来的业务价值"><a href="#项目带来的业务价值" class="headerlink" title="项目带来的业务价值"></a>项目带来的业务价值</h3><p>OpSys 不是为了”有一个运维平台”而建设的，而是为了<strong>解决真实的运维痛点</strong>：</p>
<ul>
<li>将分散的资源信息<strong>集中</strong>，降低查找成本</li>
<li>将手工的部署操作<strong>自动化</strong>，减少人为错误</li>
<li>将口头的变更流程<strong>系统化</strong>，确保可审计可追溯</li>
</ul>
<h3 id="技术选型的经验教训"><a href="#技术选型的经验教训" class="headerlink" title="技术选型的经验教训"></a>技术选型的经验教训</h3><p><strong>做对的事情</strong>：</p>
<ul>
<li>选择成熟稳定的技术栈（Django + Celery），避免踩坑</li>
<li>从第一天就考虑认证与权限，避免后期大改</li>
<li>采用模块化设计，便于团队协作和后期维护</li>
</ul>
<p><strong>可以做得更好的事情</strong>：</p>
<ul>
<li>部署系统（cd/）早期设计过于简单，导致后期重构成本高</li>
<li>测试覆盖率不足，部分功能依赖人工测试</li>
<li>文档编写滞后于开发进度</li>
</ul>
<h3 id="对运维平台建设的思考"><a href="#对运维平台建设的思考" class="headerlink" title="对运维平台建设的思考"></a>对运维平台建设的思考</h3><ol>
<li><strong>从痛点出发</strong>：不要为了技术而技术，先搞清楚要解决什么问题</li>
<li><strong>渐进式迭代</strong>：不要试图一步到位，先解决最紧迫的问题</li>
<li><strong>用户体验很重要</strong>：运维平台的用户是运维工程师，要站在他们的角度设计</li>
<li><strong>自动化不是目的</strong>：自动化是手段，提升效率、降低风险才是目的</li>
<li><strong>保持开放</strong>：与外部系统的集成能力决定了平台的价值边界</li>
</ol>
<hr>
<blockquote>
<p><strong>关于作者</strong>：Bob Zou，运维开发工程师，专注于 DevOps 工具链建设和自动化平台开发。擅长 Python/Golang 后端开发，熟悉 AWS/GCP 云平台。</p>
<p><strong>技术栈</strong>：Python (Django/DRF)、Golang (Gin)、Vue 3、Docker、Kubernetes、AWS</p>
</blockquote>
<hr>
<p><em>本文档最后更新于 2026 年 2 月</em></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='true'
        data-ae='true'
        data-ci='aae5f1ef39ad91ac18d0'
        data-cs='9bdc46e39856d885ab0ccb5de3ef37351d543ec1'
        data-r='blog.github.io'
        data-o='bob-zou'
        data-a='bob-zou'
        data-d='false'
    >查看评论</div>


    </div>
    
</div>


    </div>
    <center>
        <p class="footerlinks">
            <a href="#" class="iconfont icon-null"></a>
            
                <a href="https://github.com/bob-zou" title="github" class="iconfont icon-github" target="_blank" rel="noopener"> </a>
            
                <a href="https://cdn.jsdelivr.net/gh/bob-zou/blog.github.io/img/wechat.jpg" title="wechat" class="iconfont icon-wechat" target="_blank" rel="noopener"> </a>
            
                <a href="mailto:zyp19901009@163.com" title="email" class="iconfont icon-email" target="_blank" rel="noopener"> </a>
            
            <a href="#" class="iconfont icon-null"></a>
        </p>

        <p id="copyright">
            &copy; 2026 Bob Zou 书山有路勤为径，学海无涯苦作舟
        </p>
    </center>
</div>

</body>

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>





<!-- Google Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MTN9237PJK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MTN9237PJK');
</script>
<!-- End Google Analytics -->


</html>
